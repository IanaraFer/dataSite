<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Data Analyzer - Working Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .platform-card { 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        .upload-zone {
            border: 3px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .upload-zone:hover {
            border-color: #0056b3;
            background: #e9ecef;
            transform: translateY(-2px);
        }
        .upload-zone.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        .processing {
            background: linear-gradient(90deg, #007bff, #0056b3, #007bff);
            background-size: 200% 100%;
            animation: gradient 2s ease-in-out infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .result-card {
            border-left: 5px solid #28a745;
            margin-top: 20px;
        }
        .pricing-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FQQHWKG6SY"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FQQHWKG6SY');
</script>
<body>
    <!-- Pricing Badge -->
    <div class="pricing-badge">
        <h6 class="text-primary mb-2">
            <i class="fas fa-euro-sign me-1"></i>Updated Pricing
        </h6>
        <small class="text-muted">
            Professional: €199/month<br>
            Business: €399/month<br>
            Enterprise: €799/month
        </small>
        <div class="mt-2">
            <a href="index.html" class="btn btn-sm btn-outline-primary">View Homepage</a>
        </div>
    </div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="platform-card p-5">
                    <div class="text-center mb-4">
                        <h1 class="text-primary">
                            <i class="fas fa-brain me-3"></i>AI Data Analyzer
                        </h1>
                        <p class="lead text-muted">Upload your CSV file for instant AI analysis</p>
                    </div>

                    <!-- Upload Section -->
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h4>Drop your CSV file here</h4>
                        <p class="text-muted">or click to browse files</p>
                        <input type="file" id="fileInput" accept=".csv" style="display: none;">
                    </div>

                    <!-- Processing Status -->
                    <div id="processingStatus" class="mt-4" style="display: none;">
                        <div class="card processing text-white">
                            <div class="card-body text-center">
                                <div class="spinner-border mb-3"></div>
                                <h5>Processing Your Data...</h5>
                                <p class="mb-0">AI algorithms are analyzing your file</p>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <!-- Results will be inserted here -->
                    </div>

                    <!-- Demo Section -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-success" onclick="loadDemoData()">
                            <i class="fas fa-play me-2"></i>Try Demo Data
                        </button>
                        <button class="btn btn-outline-warning ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>Clear Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File upload functionality
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');
        window.__platformState = { data: null, headers: null, insights: null, filename: null };

        // Drag and drop handlers
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            // Show processing
            processingStatus.style.display = 'block';
            resultsSection.style.display = 'none';

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                setTimeout(() => {
                    processCSV(csv, file.name);
                }, 2000); // Simulate processing time
            };
            reader.readAsText(file);
        }

        function processCSV(csvData, filename) {
            try {
                // Parse CSV
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length && i < 100; i++) { // Limit to 100 rows for demo
                    const row = {};
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }

                // Hide processing
                processingStatus.style.display = 'none';

                // Show results
                displayResults(data, filename, headers);

            } catch (error) {
                processingStatus.style.display = 'none';
                alert('Error processing file: ' + error.message);
            }
        }

        function displayResults(data, filename, headers) {
            const totalRows = data.length;
            const totalColumns = headers.length;

            // Generate AI insights
            const insights = generateAIInsights(data, headers);
            window.__platformState = { data, headers, insights, filename };

            resultsSection.innerHTML = `
                <div class="result-card card mt-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>Analysis Complete: ${filename}
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Summary Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="bg-primary text-white rounded p-3">
                                    <h4>${totalRows.toLocaleString()}</h4>
                                    <small>Records Processed</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-success text-white rounded p-3">
                                    <h4>${totalColumns}</h4>
                                    <small>Data Columns</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-warning text-white rounded p-3">
                                    <h4>${insights.quality}%</h4>
                                    <small>Data Quality</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="bg-info text-white rounded p-3">
                                    <h4>${insights.completeness}%</h4>
                                    <small>Completeness</small>
                                </div>
                            </div>
                        </div>

                        <!-- AI Insights -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-robot me-2"></i>AI Insights</h6>
                            <ul class="mb-0">
                                ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>

                        <!-- Data Preview -->
                        <h6><i class="fas fa-table me-2"></i>Data Preview (First 10 rows)</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        ${headers.map(header => `<th>${header}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.slice(0, 10).map(row => `
                                        <tr>
                                            ${headers.map(header => `<td>${row[header] || ''}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary me-2" onclick="downloadReport('${filename}')">
                                <i class="fas fa-download me-2"></i>Download Report
                            </button>
                            <button class="btn btn-success me-2" onclick="generateForecast()">
                                <i class="fas fa-chart-line me-2"></i>Generate Forecast
                            </button>
                            <button class="btn btn-warning" onclick="exportInsights()">
                                <i class="fas fa-lightbulb me-2"></i>Export Insights
                            </button>
                        </div>
                    </div>
                </div>
            `;

            resultsSection.style.display = 'block';
        }

        function generateAIInsights(data, headers) {
            // Simulate AI analysis
            const quality = Math.floor(Math.random() * 20) + 80; // 80-100%
            const completeness = Math.floor(Math.random() * 15) + 85; // 85-100%
            
            const recommendations = [
                `Detected ${headers.length} data dimensions with ${data.length} records`,
                `Data quality score: ${quality}% - Excellent for AI analysis`,
                `Found potential revenue patterns in your dataset`,
                `Recommended for customer segmentation analysis`,
                `Suitable for 6-month forecasting models`
            ];

            return { quality, completeness, recommendations };
        }

        function loadDemoData() {
            const demoCSV = `Date,Revenue,Customers,Product,Region
2024-01-01,15000,120,Widget A,North
2024-01-02,18000,145,Widget B,South
2024-01-03,12000,98,Widget A,East
2024-01-04,22000,180,Widget C,West
2024-01-05,19000,155,Widget B,North`;

            processingStatus.style.display = 'block';
            resultsSection.style.display = 'none';

            setTimeout(() => {
                processCSV(demoCSV, 'demo-business-data.csv');
            }, 1500);
        }

        function clearResults() {
            resultsSection.style.display = 'none';
            processingStatus.style.display = 'none';
            fileInput.value = '';
        }

        function downloadReport(filename) {
            try {
                const state = window.__platformState || {};
                if (!state || !state.data || !state.headers) {
                    alert('Please upload data or load demo first.');
                    return;
                }

                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) {
                    alert('PDF library failed to load. Please refresh and try again.');
                    return;
                }

                const doc = new jsPDF();
                const reportTitle = 'Analytica Core AI - Business Report';
                const now = new Date();
                const fileLabel = state.filename || filename || 'dataset.csv';

                doc.setFontSize(18);
                doc.text(reportTitle, 14, 20);
                doc.setFontSize(11);
                doc.text(`Generated: ${now.toLocaleString()}`, 14, 28);
                doc.text(`File: ${fileLabel}`, 14, 34);

                // Summary
                doc.setFontSize(14);
                doc.text('Summary', 14, 46);
                doc.setFontSize(11);
                const summaryLines = [
                    `Records processed: ${state.data.length.toLocaleString()}`,
                    `Columns detected: ${state.headers.length}`,
                    `Data Quality: ${state.insights?.quality ?? 'N/A'}%`,
                    `Completeness: ${state.insights?.completeness ?? 'N/A'}%`
                ];
                let y = 52;
                summaryLines.forEach(line => { doc.text(`• ${line}`, 18, y); y += 6; });

                // Insights
                doc.setFontSize(14);
                doc.text('AI Insights', 14, y + 6);
                doc.setFontSize(11);
                y += 12;
                const recs = (state.insights?.recommendations || []).slice(0, 8);
                if (recs.length === 0) {
                    doc.text('No insights available.', 18, y);
                    y += 6;
                } else {
                    recs.forEach(rec => { doc.text(`• ${rec}`, 18, y); y += 6; });
                }

                const outName = `Analytica_Report_${now.toISOString().slice(0,10)}.pdf`;
                doc.save(outName);
            } catch (err) {
                console.error('Download report error:', err);
                alert('Failed to generate report: ' + (err?.message || err));
            }
        }

        function generateForecast() {
            try {
                const state = window.__platformState || {};
                if (!state || !state.data || state.data.length === 0) {
                    alert('Please upload data or load demo first.');
                    return;
                }

                const headers = state.headers || Object.keys(state.data[0] || {});
                const dateKey = headers.find(h => /date|time/i.test(h)) || 'Date';
                let valueKey = headers.find(h => /revenue|sales|amount|value/i.test(h));
                if (!valueKey) {
                    valueKey = headers.find(h => !isNaN(parseFloat(state.data[0][h])));
                }
                const series = state.data
                    .map(row => ({
                        date: row[dateKey] ? new Date(row[dateKey]) : null,
                        value: parseFloat((row[valueKey] ?? '').toString().replace(/[€$,]/g, ''))
                    }))
                    .filter(p => !isNaN(p.value));
                if (series.length < 5) {
                    alert('Not enough numeric data to generate forecast.');
                    return;
                }

                const hasDates = series.every(p => p.date instanceof Date && !isNaN(p.date));
                if (hasDates) series.sort((a, b) => a.date - b.date);

                const y = series.map(p => p.value);
                const n = y.length;
                const x = Array.from({ length: n }, (_, i) => i);
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = y.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((s, xi, i) => s + xi * y[i], 0);
                const sumXX = x.reduce((s, xi) => s + xi * xi, 0);
                const slope = (n * sumXY - sumX * sumY) / Math.max(1, (n * sumXX - sumX * sumX));
                const intercept = (sumY - slope * sumX) / n;

                const historyDates = hasDates ? series.slice(-30).map(p => p.date.toISOString().slice(0,10)) : x.slice(-30).map(i => i.toString());
                const historyVals = y.slice(-30);
                const forecastDates = [];
                const forecastVals = [];
                for (let i = 1; i <= 30; i++) {
                    const idx = n + i - 1;
                    const base = intercept + slope * idx;
                    const seasonal = 0.1 * base * Math.sin((i / 7) * 2 * Math.PI);
                    const predicted = Math.max(0, base + seasonal);
                    forecastVals.push(predicted);
                    if (hasDates) {
                        const d = new Date(series[series.length - 1].date);
                        d.setDate(d.getDate() + i);
                        forecastDates.push(d.toISOString().slice(0,10));
                    } else {
                        forecastDates.push((idx).toString());
                    }
                }

                const existing = document.getElementById('forecastSection');
                if (existing) existing.remove();
                const html = `
                    <div id="forecastSection" class="card mt-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>30-Day Forecast</h6>
                        </div>
                        <div class="card-body">
                            <div id="forecastChart" style="height: 360px;"></div>
                        </div>
                    </div>`;
                resultsSection.insertAdjacentHTML('beforeend', html);

                const traces = [
                    { x: historyDates, y: historyVals, type: 'scatter', mode: 'lines', name: 'Historical', line: { color: '#1f77b4', width: 3 } },
                    { x: forecastDates, y: forecastVals, type: 'scatter', mode: 'lines', name: 'Forecast', line: { color: '#ff7f0e', width: 3, dash: 'dash' } }
                ];
                const layout = { margin: { t: 30, r: 20, b: 40, l: 60 }, xaxis: { title: hasDates ? 'Date' : 'Index' }, yaxis: { title: 'Value' }, showlegend: true };
                if (typeof Plotly !== 'undefined') {
                    Plotly.newPlot('forecastChart', traces, layout, { displayModeBar: false, responsive: true });
                } else {
                    document.getElementById('forecastChart').innerText = 'Chart library failed to load.';
                }
            } catch (err) {
                console.error('Forecast error:', err);
                alert('Failed to generate forecast: ' + (err?.message || err));
            }
        }

        function exportInsights() {
            try {
                const state = window.__platformState || {};
                if (!state || !state.insights || !state.data) {
                    alert('Please upload data or load demo first.');
                    return;
                }
                const payload = {
                    file: state.filename,
                    generatedAt: new Date().toISOString(),
                    summary: { records: state.data.length, columns: state.headers?.length || 0, quality: state.insights.quality, completeness: state.insights.completeness },
                    recommendations: state.insights.recommendations
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const base = (state.filename || 'insights').replace(/\.[^/.]+$/, '');
                a.download = `${base}_ai_insights.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Export insights error:', err);
                alert('Failed to export insights: ' + (err?.message || err));
            }
        }

        // Clear browser cache for pricing
        console.log('🔄 Platform loaded with latest pricing: Professional €199, Business €399, Enterprise €799');
        
        // Add cache busting
        if (window.location.search.indexOf('v=') === -1) {
            const separator = window.location.search ? '&' : '?';
            window.history.replaceState({}, '', window.location.pathname + window.location.search + separator + 'v=' + Date.now());
        }
    </script>
</body>
</html>
