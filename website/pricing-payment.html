<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Plan - DataSight AI</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; color: white; margin-bottom: 50px; }
        .header h1 { font-size: 3rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; margin-bottom: 50px; }
        
        .plan-card { 
            background: white; 
            border-radius: 20px; 
            padding: 40px 30px; 
            text-align: center; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .plan-card:hover { transform: translateY(-10px); box-shadow: 0 30px 60px rgba(0,0,0,0.15); }
        
        .plan-card.featured { 
            border: 3px solid #667eea; 
            transform: scale(1.05);
        }
        
        .plan-card.featured::before {
            content: "MOST POPULAR";
            position: absolute;
            top: 20px;
            right: -30px;
            background: #667eea;
            color: white;
            padding: 5px 40px;
            font-size: 12px;
            font-weight: bold;
            transform: rotate(45deg);
        }
        
        .plan-name { font-size: 1.8rem; font-weight: 700; color: #333; margin-bottom: 10px; }
        .plan-price { font-size: 3rem; font-weight: 900; color: #667eea; margin-bottom: 5px; }
        .plan-price .currency { font-size: 1.5rem; vertical-align: super; }
        .plan-price .period { font-size: 1rem; color: #666; font-weight: normal; }
        .plan-description { color: #666; margin-bottom: 30px; font-size: 0.95rem; }
        
        .features { text-align: left; margin-bottom: 30px; }
        .features li { 
            list-style: none; 
            padding: 8px 0; 
            position: relative; 
            padding-left: 25px;
            color: #555;
        }
        .features li::before { 
            content: "✓"; 
            position: absolute; 
            left: 0; 
            color: #28a745; 
            font-weight: bold; 
        }
        
        .plan-button { 
            width: 100%; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 50px; 
            font-size: 1.1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        
        .btn-secondary { background: transparent; color: #667eea; border: 2px solid #667eea; }
        .btn-secondary:hover { background: #667eea; color: white; }
        
        .trial-note { text-align: center; color: white; margin-top: 30px; opacity: 0.9; }
        .trial-note a { color: #ffd700; text-decoration: none; font-weight: 600; }
        
        .payment-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content { 
            background: white; 
            max-width: 500px; 
            margin: 50px auto; 
            border-radius: 20px; 
            padding: 40px;
            position: relative;
        }
        
        .close-modal { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            font-size: 2rem; 
            cursor: pointer; 
            color: #999;
        }
        
        .payment-form { margin-top: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus { border-color: #667eea; outline: none; }
        
        #card-element { 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }
        
        #card-element.StripeElement--focus { border-color: #667eea; }
        
        .payment-button { 
            width: 100%; 
            padding: 15px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            font-weight: 600; 
            cursor: pointer;
            margin-top: 20px;
        }
        
        .payment-button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .security-note { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
            font-size: 0.9rem; 
            color: #666;
            text-align: center;
        }
        
        .spinner { 
            display: none; 
            width: 20px; 
            height: 20px; 
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #667eea; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .success-message { 
            background: #d4edda; 
            color: #155724; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
            text-align: center;
            display: none;
        }
        
        .error-message { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Choose Your Plan</h1>
            <p>Start your AI-powered business transformation today</p>
        </div>
        
        <div class="pricing-grid">
            <!-- Starter Plan -->
            <div class="plan-card">
                <div class="plan-name">Starter</div>
                <div class="plan-price">
                    <span class="currency">€</span>199
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Perfect for small businesses ready to embrace AI insights</div>
                <ul class="features">
                    <li>Up to 5 datasets per month</li>
                    <li>Basic AI insights & recommendations</li>
                    <li>Standard reporting (PDF)</li>
                    <li>Email support</li>
                    <li>Data storage for 30 days</li>
                    <li>Basic forecasting models</li>
                </ul>
                <button class="plan-button btn-secondary" onclick="selectPlan('starter', 199)">
                    Start Starter Plan
                </button>
            </div>
            
            <!-- Professional Plan -->
            <div class="plan-card featured">
                <div class="plan-name">Professional</div>
                <div class="plan-price">
                    <span class="currency">€</span>399
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Ideal for growing companies seeking advanced analytics</div>
                <ul class="features">
                    <li>Up to 20 datasets per month</li>
                    <li>Advanced AI insights & predictions</li>
                    <li>Interactive dashboards</li>
                    <li>Priority support + phone</li>
                    <li>Data storage for 90 days</li>
                    <li>Advanced forecasting & trends</li>
                    <li>Custom alerts & notifications</li>
                    <li>Team collaboration tools</li>
                </ul>
                <button class="plan-button btn-primary" onclick="selectPlan('professional', 399)">
                    Start Professional Plan
                </button>
            </div>
            
            <!-- Enterprise Plan -->
            <div class="plan-card">
                <div class="plan-name">Enterprise</div>
                <div class="plan-price">
                    <span class="currency">€</span>799
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Complete solution for data-driven enterprises</div>
                <ul class="features">
                    <li>Unlimited datasets</li>
                    <li>AI-powered business intelligence</li>
                    <li>Real-time analytics dashboard</li>
                    <li>Dedicated account manager</li>
                    <li>Unlimited data storage</li>
                    <li>Custom AI models</li>
                    <li>API access & integrations</li>
                    <li>White-label reporting</li>
                    <li>24/7 premium support</li>
                </ul>
                <button class="plan-button btn-primary" onclick="selectPlan('enterprise', 799)">
                    Start Enterprise Plan
                </button>
            </div>
        </div>
        
        <div class="trial-note">
            <p>💡 Not sure which plan is right for you? <a href="free-trial-simple.html">Start with our 7-day free trial</a></p>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="payment-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            <h2 id="modalTitle">Complete Your Subscription</h2>
            <div id="selectedPlanInfo"></div>
            
            <form id="payment-form" class="payment-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required placeholder="your@email.com">
                </div>
                
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required placeholder="John Doe">
                </div>
                
                <div class="form-group">
                    <label for="company">Company Name</label>
                    <input type="text" id="company" name="company" placeholder="Your Company Ltd.">
                </div>
                
                <div class="form-group">
                    <label for="card-element">Credit or Debit Card</label>
                    <div id="card-element">
                        <!-- Stripe Elements will create form elements here -->
                    </div>
                    <div id="card-errors" role="alert"></div>
                </div>
                
                <button type="submit" id="submit-payment" class="payment-button">
                    <span id="button-text">Subscribe Now</span>
                    <div id="spinner" class="spinner"></div>
                </button>
                
                <div class="security-note">
                    🔒 Your payment information is secure and encrypted. We use Stripe for processing payments.
                </div>
                
                <div id="success-message" class="success-message"></div>
                <div id="error-message" class="error-message"></div>
            </form>
        </div>
    </div>

    <script>
        // Stripe configuration
        const stripe = Stripe('pk_test_51RyYQACsG7kLS0L9OKlEvotKwsqqfOcCbQ6YNHZsbaahjO1arljVNdl4rAeogCMWUJam9sr04awRzEdhBN5owwzt009JDUDzSv');
        const elements = stripe.elements();
        
        // Create card element
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#424770',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
            },
        });
        
        let selectedPlan = null;
        let selectedPrice = 0;
        
        function selectPlan(planName, price) {
            selectedPlan = planName;
            selectedPrice = price;
            
            // Update modal content
            document.getElementById('modalTitle').textContent = `Subscribe to ${planName.charAt(0).toUpperCase() + planName.slice(1)} Plan`;
            document.getElementById('selectedPlanInfo').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">${planName.charAt(0).toUpperCase() + planName.slice(1)} Plan</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #667eea;">€${price}/month</div>
                    <p style="margin: 10px 0 0 0; color: #666;">Billed monthly • Cancel anytime</p>
                </div>
            `;
            
            // Show modal
            document.getElementById('paymentModal').style.display = 'block';
            
            // Mount card element if not already mounted
            if (!cardElement._mounted) {
                cardElement.mount('#card-element');
                cardElement._mounted = true;
            }
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            // Clear any error messages
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
        
        // Handle real-time validation errors from the card Element
        cardElement.on('change', ({error}) => {
            const displayError = document.getElementById('card-errors');
            if (error) {
                displayError.textContent = error.message;
            } else {
                displayError.textContent = '';
            }
        });
        
        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const submitButton = document.getElementById('submit-payment');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            
            // Show loading state
            submitButton.disabled = true;
            buttonText.style.display = 'none';
            spinner.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            try {
                // Get form data
                const formData = new FormData(form);
                const customerData = {
                    email: formData.get('email'),
                    name: formData.get('name'),
                    company: formData.get('company'),
                    plan: selectedPlan,
                    price: selectedPrice
                };
                
                // Create payment method with Stripe
                const {error, paymentMethod} = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: customerData.name,
                        email: customerData.email,
                    },
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                // Send to backend for subscription creation
                const response = await fetch('http://localhost:8001/api/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_method_id: paymentMethod.id,
                        customer_data: customerData
                    }),
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Payment failed');
                }
                
                // Handle 3D Secure authentication if required
                if (result.requires_action) {
                    const {error: confirmError} = await stripe.confirmCardPayment(result.payment_intent_client_secret);
                    if (confirmError) {
                        throw new Error(confirmError.message);
                    }
                }
                
                // Success!
                successMessage.innerHTML = `
                    <h3>🎉 Welcome to DataSight AI!</h3>
                    <p>Your ${selectedPlan} subscription is now active.</p>
                    <p>Customer ID: <strong>${result.customer_id}</strong></p>
                    <p>You'll receive a confirmation email shortly.</p>
                `;
                successMessage.style.display = 'block';
                
                // Hide form
                form.style.display = 'none';
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = `dashboard.html?plan=${selectedPlan}&customer_id=${result.customer_id}`;
                }, 3000);
                
            } catch (error) {
                console.error('Payment error:', error);
                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target == modal) {
                closePaymentModal();
            }
        }
        
        // Track analytics
        function trackPlanSelection(plan, price) {
            // Google Analytics tracking
            if (typeof gtag !== 'undefined') {
                gtag('event', 'select_plan', {
                    'plan_name': plan,
                    'plan_price': price,
                    'currency': 'EUR'
                });
            }
            
            console.log(`Plan selected: ${plan} - €${price}/month`);
        }
        
        // Add plan selection tracking
        const originalSelectPlan = selectPlan;
        selectPlan = function(planName, price) {
            trackPlanSelection(planName, price);
            originalSelectPlan(planName, price);
        };
    </script>
</body>
</html>
